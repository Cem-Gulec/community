# Install package


```R
# # install community
# library(devtools)

# devtools::install_github("SoloveyMaria/community")
```

# Calculate communication


```R
# libraries
library(community)
library(data.table) #to read gz file
```


```R
input_dir <- "input_data/"
output_dir <- "computed_results/"
```


```R
sessionInfo()
```


    R version 4.1.2 (2021-11-01)
    Platform: x86_64-pc-linux-gnu (64-bit)
    Running under: Ubuntu 22.04.2 LTS
    
    Matrix products: default
    BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
    LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so
    
    locale:
     [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
     [3] LC_TIME=de_DE.UTF-8        LC_COLLATE=en_US.UTF-8    
     [5] LC_MONETARY=de_DE.UTF-8    LC_MESSAGES=en_US.UTF-8   
     [7] LC_PAPER=de_DE.UTF-8       LC_NAME=C                 
     [9] LC_ADDRESS=C               LC_TELEPHONE=C            
    [11] LC_MEASUREMENT=de_DE.UTF-8 LC_IDENTIFICATION=C       
    
    attached base packages:
    [1] stats     graphics  grDevices utils     datasets  methods   base     
    
    other attached packages:
    [1] data.table_1.14.8 community_1.3.9  
    
    loaded via a namespace (and not attached):
     [1] pillar_1.9.0     compiler_4.1.2   base64enc_0.1-3  tools_4.1.2     
     [5] digest_0.6.31    uuid_1.1-0       jsonlite_1.8.4   evaluate_0.19   
     [9] lifecycle_1.0.3  tibble_3.2.1     gtable_0.3.3     pkgconfig_2.0.3 
    [13] rlang_1.1.1      IRdisplay_1.1    cli_3.6.1        DBI_1.1.3       
    [17] IRkernel_1.3     fastmap_1.1.0    gridExtra_2.3    repr_1.1.4      
    [21] dplyr_1.0.10     generics_0.1.3   vctrs_0.6.3      grid_4.1.2      
    [25] tidyselect_1.2.0 glue_1.6.2       R6_2.5.1         fansi_1.0.4     
    [29] pbdZMQ_0.3-7     ggplot2_3.4.2    magrittr_2.0.3   scales_1.2.1    
    [33] htmltools_0.5.4  assertthat_0.2.1 colorspace_2.1-0 utf8_1.2.3      
    [37] munsell_0.5.0    crayon_1.5.2    


## Load data

To calculate interactions, we will need the following files: normalized and batch corrected `counts`, cell annotation file `anno_cells`, and a sample annotation file `anno_samples`.

The `counts` file contains normalized and batch corrected counts with genes in the rows and cell IDs in the columns.

The `anno_cells` file should contain columns named cell_ID, cell_type and sample_ID.

The `anno_sample` file should contain columns named sample_ID health_status (e.g. "healthy" or "AML") and case_or_control (e.g. "control" or "case").


```R
data("LR_database")
```


```R
# data("LR_database")
print(str(LR_database))
```

    'data.frame':	6941 obs. of  26 variables:
     $ Pair.Name            : chr  "A2M_LRP1" "ACTR2_ADRB2" "ACTR2_LDLR" "ACTR2_LRP2" ...
     $ Ligand               : chr  "A2M" "ACTR2" "ACTR2" "ACTR2" ...
     $ Ligand.Name          : chr  "alpha-2-macroglobulin" "actin related protein 2" "actin related protein 2" "actin related protein 2" ...
     $ Receptor             : chr  "LRP1" "ADRB2" "LDLR" "LRP2" ...
     $ Receptor.Name        : chr  "LDL receptor related protein 1" "adrenoceptor beta 2" "low density lipoprotein receptor" "LDL receptor related protein 2" ...
     $ complex_pair         : chr  NA NA NA NA ...
     $ partner_a            : chr  "P01023" "P61160" "P61160" "P61160" ...
     $ partner_b            : chr  "Q07954" "P07550" "P01130" "P98164" ...
     $ source               : chr  "P01023" "P61160" "P61160" "P61160" ...
     $ target               : chr  "Q07954" "P07550" "P01130" "P98164" ...
     $ source_genesymbol    : chr  "A2M" "ACTR2" "ACTR2" "ACTR2" ...
     $ target_genesymbol    : chr  "LRP1" "ADRB2" "LDLR" "LRP2" ...
     $ is_directed          : num  1 1 1 1 1 1 1 1 1 1 ...
     $ is_stimulation       : num  1 0 0 0 1 0 1 0 0 0 ...
     $ is_inhibition        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ consensus_direction  : num  1 0 0 0 1 0 1 0 0 0 ...
     $ consensus_stimulation: num  1 0 0 0 1 0 1 0 0 0 ...
     $ consensus_inhibition : num  0 0 0 0 0 0 0 0 0 0 ...
     $ sources              : chr  "AlzPathway;Baccin2019;CellTalkDB;EMBRACE;Fantom5_LRdb;HPMR_LRdb;HPMR_talklr;HPRD;HPRD_LRdb;HPRD_talklr;LRdb;Ram"| __truncated__ "CellTalkDB;LRdb;Reactome_LRdb" "CellTalkDB;LRdb;Reactome_LRdb" "CellTalkDB;LRdb;Reactome_LRdb" ...
     $ references           : chr  "AlzPathway:19026743;Baccin2019:10652313;Baccin2019:12194978;Baccin2019:1702392;CellTalkDB:10652313;HPRD:1065231"| __truncated__ "CellTalkDB:32196115" "CellTalkDB:32196115" "CellTalkDB:32196115" ...
     $ curation_effort      : num  11 1 1 1 0 1 39 1 1 1 ...
     $ n_references         : num  4 1 1 1 0 1 9 1 1 1 ...
     $ n_resources          : int  11 2 2 2 1 1 19 2 2 3 ...
     $ annotation_strategy  : chr  "LR" "LR" "LR" "LR" ...
     $ db                   : chr  "both" "both" "both" "both" ...
     $ True_LR              : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
    NULL



```R
# # load counts
print("load counts")
counts <- fread(paste0(input_dir,"counts_corr.csv.gz"), header = TRUE)
counts <- as.data.frame(counts)
rownames(counts) <- counts$gene_symbol
counts <- counts[,-1]
print(str(counts))
```

    [1] "load counts"
    'data.frame':	15770 obs. of  46702 variables:
     $ 2020.09.15.AML0024.CATCAAGGTTAGCGGA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATCAAGTCCGAGAAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATCCACAGGGACCAT           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCAACAGAGCAAGA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCAACAGTTCCATG           : num  0 0.69 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCAACGTAGAATAC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCAACGTTCTCCCA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCAACTCCGAACGC           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCAACTCTAGTCAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCACAAGACAGTCG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCACACAATTGCCA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCACACAGAACTAA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCACACAGCTGAAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCACAGTAATCAGA           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCACAGTACTCCGG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTCAACAGAACGCGT           : num  0 0 0.732 0 0 ...
     $ 2020.09.15.AML0024.CATACTTAGGCGTTAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATACTTAGTTGCATC           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATACTTCAACTTGGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATACTTTCCTTGACC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATAGACAGCACTAAA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATAGACAGGATCACG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATAGACAGGGAGTGG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATAGACCACACAGCC           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATAGACTCCATTGGA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATCAAGAGAGTTCGG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CATCAAGAGAGTTGCG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTAAGATCGAGAGCA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTACGTAGCCGTAAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTACGTCATCCTTCG           : num  0 0 0 0 0.452 ...
     $ 2020.09.15.AML0024.CCTACGTGTATTTCTC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTACGTGTCTCAGAT           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTACGTTCCACAAGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGAGAATCCCT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGAGGAGACCT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGAGTCGAGGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGCAGAACGCA           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGCAGCTCGGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGGTAAGTTGA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGGTCAGTCCG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGTCCGTGTAA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGTCGTAGCCG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.CCTATCGTCTACCACC           : num  0 0 0.491 0 0 ...
     $ 2020.09.15.AML0024.AAACCCACAACATACC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACCCAGTACAACGG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACCCAGTTGTAGCT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACCCATCATCTGTT           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACCCATCTCAGAAC           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGAACAAGTTCGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGAACAGCAGTTT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGAAGTAACAGTA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGAATCTTTGGAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGCTAGATTAGTG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGCTAGCGAATGC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGCTAGTTCCTGA           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAACGCTGTCTACAAC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACAGCACCCAC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACAGCGGACAT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACAGCTGACTT           : num  0 0 0 0.647 0 ...
     $ 2020.09.15.AML0024.AAAGAACAGGGCTTCC           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACAGTAAGCAT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACCAACAAAGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACGTACTCGCG           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACGTCATCGCG           : num  0 0.798 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACGTGCATACT           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACGTTTCCAAG           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACTCCAAATGC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGAACTCTGGGTCG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATAGCCAGACA           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATAGCTAGCCC           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATAGGCTGGAT           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATAGTTGGCTT           : num  0 0.535 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATCAGACCCGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATCATCGCTGG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATCATTGGGAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGATTCCCATACC           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGGCCAATTAGGA           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGGCGTGGTCTCG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGGCGTTGGGCCT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGGCTCATGCCCT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGTAAGGACTGGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGTAAGGGAGGTG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGTACATCTCAAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGTATCCTAAGTG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGTATCTCAGAAC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGGTATCTGATTCT           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTCCCACCAGTTA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTCCCAGAACGCA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAAGATCCGAG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAAGCGTGTCC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAAGGTGGTTG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAAGTCAGGGT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAAGTGAATAC           : num  0 0 0.598 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGACAACCGCCA           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAGTCAACCTA           : num  0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAGTCGTTGCG           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGAGTTACACAC           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAAGTGATCATTCGTT           : num  0 0 0 0 0 0 0 0 0 0 ...
     $ 2020.09.15.AML0024.AAATGGAAGCTGTGCC           : num  0 0 0 0 0 0 0 0 0 0 ...
      [list output truncated]
    NULL



```R
# load cell annotation
print("load cell annotation")
anno_cells <- read.table(paste0(input_dir,"anno_cells_corr.txt")
                         ,sep = "\t"
                         ,row.names = 1
                         ,header = TRUE
                         )
print(str(anno_cells))
```

    [1] "load cell annotation"
    'data.frame':	46702 obs. of  93 variables:
     $ sample_ID                    : chr  "AML-0024" "AML-0024" "AML-0024" "AML-0024" ...
     $ cell                         : chr  "2020-09-15-AML0024:CATCAAGGTTAGCGGA" "2020-09-15-AML0024:CATCAAGTCCGAGAAG" "2020-09-15-AML0024:CATCCACAGGGACCAT" "2020-09-15-AML0024:CCTCAACAGAGCAAGA" ...
     $ UMAP_1                       : num  -0.731 -2.2 -2.867 -1.666 -0.972 ...
     $ UMAP_2                       : num  -15.8 -16.7 -16.1 -16.1 -17.5 ...
     $ orig.ident                   : chr  "2020-09-15-AML0024" "2020-09-15-AML0024" "2020-09-15-AML0024" "2020-09-15-AML0024" ...
     $ samples                      : chr  "AML0024" "AML0024" "AML0024" "AML0024" ...
     $ Broad_cell_identity          : chr  "CD14+ monocyte" "CD14+ monocyte" "CD16+ monocyte" "CD14+ monocyte" ...
     $ Cell_type_identity           : chr  "CD14+ IFN+" "CD14+" "CD16+" "CD14+ IFN+" ...
     $ clusters_res.2               : int  7 7 7 7 80 7 7 7 7 7 ...
     $ CNV_pos                      : chr  "CNV+" "CNV+" "CNV+" "CNV+" ...
     $ malignant                    : chr  "malignant" "malignant" "malignant" "malignant" ...
     $ aml                          : chr  "AML" "AML" "AML" "AML" ...
     $ ap_aml_age                   : chr  "adult_AML" "adult_AML" "adult_AML" "adult_AML" ...
     $ age_group                    : chr  "adult_60up" "adult_60up" "adult_60up" "adult_60up" ...
     $ sex.x                        : chr  "male" "male" "male" "male" ...
     $ inflammation_group           : chr  "Inflammation_high" "Inflammation_high" "Inflammation_high" "Inflammation_high" ...
     $ occupancy_score              : num  1 1 1 1 1 1 1 1 1 1 ...
     $ GSM                          : chr  "GSM5613779" "GSM5613779" "GSM5613779" "GSM5613779" ...
     $ date                         : chr  "2020-09-15" "2020-09-15" "2020-09-15" "2020-09-15" ...
     $ cell_ID.1                    : chr  "2020.09.15.AML0024.CATCAAGGTTAGCGGA" "2020.09.15.AML0024.CATCAAGTCCGAGAAG" "2020.09.15.AML0024.CATCCACAGGGACCAT" "2020.09.15.AML0024.CCTCAACAGAGCAAGA" ...
     $ cell_type_original           : chr  "CD14+ monocyte" "CD14+ monocyte" "CD16+ monocyte" "CD14+ monocyte" ...
     $ Sample.ID                    : chr  "U-06-0024" "U-06-0024" "U-06-0024" "U-06-0024" ...
     $ sex.y                        : chr  "M" "M" "M" "M" ...
     $ Age                          : int  64 64 64 64 64 64 64 64 64 64 ...
     $ Sequencing                   : chr  "CITE-seq" "CITE-seq" "CITE-seq" "CITE-seq" ...
     $ Institution                  : chr  "OSU" "OSU" "OSU" "OSU" ...
     $ Manuscript.ID                : chr  "AML0024" "AML0024" "AML0024" "AML0024" ...
     $ Dx                           : chr  "AML" "AML" "AML" "AML" ...
     $ DxELN_Cytogenetic            : chr  "Adverse" "Adverse" "Adverse" "Adverse" ...
     $ Cytogenetics                 : chr  "48,XY,+8,+8,i(8)(p10),t(9;15)(q33;q15),del(10)(q22.1q24),del(13)(q14q21)" "48,XY,+8,+8,i(8)(p10),t(9;15)(q33;q15),del(10)(q22.1q24),del(13)(q14q21)" "48,XY,+8,+8,i(8)(p10),t(9;15)(q33;q15),del(10)(q22.1q24),del(13)(q14q21)" "48,XY,+8,+8,i(8)(p10),t(9;15)(q33;q15),del(10)(q22.1q24),del(13)(q14q21)" ...
     $ Overall.survival             : num  137 137 137 137 137 137 137 137 137 137 ...
     $ Flow.report.summary          : chr  "" "" "" "" ...
     $ RAS.pathway                  : chr  "" "" "" "" ...
     $ NPM1                         : chr  "" "" "" "" ...
     $ IDH                          : chr  "" "" "" "" ...
     $ TET2                         : chr  "" "" "" "" ...
     $ TP53                         : chr  "" "" "" "" ...
     $ RUNX1                        : chr  "" "" "" "" ...
     $ CBF                          : logi  NA NA NA NA NA NA ...
     $ MLL.rearranged               : logi  NA NA NA NA NA NA ...
     $ IDH1                         : chr  "0+T2:BL24" "0+T2:BL24" "0+T2:BL24" "0+T2:BL24" ...
     $ IDH2                         : chr  "0,46" "0,46" "0,46" "0,46" ...
     $ ASXL1                        : chr  "0" "0" "0" "0" ...
     $ BCOR                         : chr  "0,99" "0,99" "0,99" "0,99" ...
     $ CBL                          : num  0 0 0 0 0 0 0 0 0 0 ...
     $ CEBPAdm                      : num  0 0 0 0 0 0 0 0 0 0 ...
     $ CSF3R                        : chr  "0" "0" "0" "0" ...
     $ DNMT3A                       : chr  "0" "0" "0" "0" ...
     $ ETV6                         : num  0 0 0 0 0 0 0 0 0 0 ...
     $ FLT3.TKD                     : chr  "0,06" "0,06" "0,06" "0,06" ...
     $ FLT3.ITD                     : num  0 0 0 0 0 0 0 0 0 0 ...
     $ GATA2                        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ JAK2                         : num  0 0 0 0 0 0 0 0 0 0 ...
     $ KIT                          : num  0 0 0 0 0 0 0 0 0 0 ...
     $ NPM1.1                       : chr  "0,17" "0,17" "0,17" "0,17" ...
     $ NRAS                         : num  0 0 0 0 0 0 0 0 0 0 ...
     $ KRAS                         : chr  "0" "0" "0" "0" ...
     $ PTPN11                       : chr  "0,17" "0,17" "0,17" "0,17" ...
     $ PHF6                         : num  0 0 0 0 0 0 0 0 0 0 ...
     $ RAD21                        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ RUNX1.1                      : chr  "0" "0" "0" "0" ...
     $ SETBP1                       : num  0 0 0 0 0 0 0 0 0 0 ...
     $ SMC1A                        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ STAG2                        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ SRSF2                        : chr  "0" "0" "0" "0" ...
     $ SF3B1                        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ TET2.1                       : chr  "0" "0" "0" "0" ...
     $ U2AF1                        : chr  "0,45" "0,45" "0,45" "0,45" ...
     $ WT1                          : num  0 0 0 0 0 0 0 0 0 0 ...
     $ TP53.1                       : chr  "0" "0" "0" "0" ...
     $ ZRSR2                        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ health_status                : chr  "AML" "AML" "AML" "AML" ...
     $ case_or_control              : chr  "case" "case" "case" "case" ...
     $ cell_type                    : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ cell_subtype                 : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ total_counts_raw             : num  2591 2598 2665 2751 2845 ...
     $ mito_counts                  : num  31.5 37.5 40.8 37.1 44.3 ...
     $ frac_mito                    : num  0.0122 0.0144 0.0153 0.0135 0.0156 ...
     $ nr_genes                     : int  1946 2177 2027 2731 2161 2297 2783 2352 2691 2659 ...
     $ counts_upper_threshold       : int  30000 30000 30000 30000 30000 30000 30000 30000 30000 30000 ...
     $ counts_lower_threshold       : int  1100 1100 1100 1100 1100 1100 1100 1100 1100 1100 ...
     $ genes_lower_threshold        : int  500 500 500 500 500 500 500 500 500 500 ...
     $ counts_upper_filter          : chr  "True" "True" "True" "True" ...
     $ counts_lower_filter          : chr  "True" "True" "True" "True" ...
     $ genes_lower_filter           : chr  "True" "True" "True" "True" ...
     $ cell_filter                  : chr  "True" "True" "True" "True" ...
     $ threshold_celltype_size      : int  5 5 5 5 5 5 5 5 5 5 ...
     $ celltype_size_cf             : int  5451 5451 5451 5451 5451 5451 5451 5451 5451 452 ...
     $ celltype_size_filter         : chr  "True" "True" "True" "True" ...
     $ cell_type_ID                 : chr  "Mono_AML-0024" "Mono_AML-0024" "Mono_AML-0024" "Mono_AML-0024" ...
     $ total_counts_raw_cf_ctf_gf   : num  2584 2594 2656 2743 2843 ...
     $ total_counts_raw_cf_ctf_gf_sf: num  2584 2594 2656 2743 2843 ...
     $ bares_mutation               : chr  "malignant" "malignant" "malignant" "malignant" ...
    NULL



```R
# load sample annotation
print("load sample annotation")
anno_samples <- read.table(paste0(input_dir,"anno_samples_corr.txt")
                           ,sep = "\t"
                           ,row.names = 1
                           ,header = TRUE
                           )
print(str(anno_samples))
```

    [1] "load sample annotation"
    'data.frame':	13 obs. of  60 variables:
     $ Sample.ID                    : chr  "U-06-0024" "U-16-0160" "U-11-0693" "U-18-1371" ...
     $ sex                          : chr  "M" "M" "F" "M" ...
     $ Age                          : int  64 74 77 78 71 57 80 26 39 50 ...
     $ Sequencing                   : chr  "CITE-seq" "CITE-seq" "CITE-seq + scTCR-seq" "CITE-seq" ...
     $ sample_ID                    : chr  "AML-0024" "AML-0160" "AML-0693" "AML-1371" ...
     $ Institution                  : chr  "OSU" "OSU" "OSU" "OSU" ...
     $ Manuscript.ID                : chr  "AML0024" "AML0160" "AML0693" "AML1371" ...
     $ Dx                           : chr  "AML" "AML" "AML" "AML" ...
     $ DxELN_Cytogenetic            : chr  "Adverse" "Adverse" "Adverse" "" ...
     $ Cytogenetics                 : chr  "48,XY,+8,+8,i(8)(p10),t(9;15)(q33;q15),del(10)(q22.1q24),del(13)(q14q21)" "46,XY[30]" "74-89<4n>,XXXX,-8,-9,-9,-12,-17,i(17)(q10),+mar1,+mar2,+dmin[cp18]/46,XX[2] .ish dmin(amp CMYC)" "46,XY (17 metas), -Y in 3 metas" ...
     $ Overall.survival             : num  137 3 47 631 1807 ...
     $ Flow.report.summary          : chr  "" "Blasts/promonocytes (30%) and monocytes (33%) represent the majority of the differential count of the bone marr"| __truncated__ "Immunohistochemical stains are performed on the bone marrow biopsy for CD34, CD117, CD79a, CD3, MPO, TdT, and C"| __truncated__ "Blasts, defined by CD45 faint \nstaining and low side scatter represent 72.4 % of the total events \nanalyzed a"| __truncated__ ...
     $ RAS.pathway                  : chr  "" "" "" "" ...
     $ NPM1                         : chr  "" "" "" "x" ...
     $ IDH                          : chr  "" "" "" "x" ...
     $ TET2                         : chr  "" "x" "" "" ...
     $ TP53                         : chr  "" "" "x" "" ...
     $ RUNX1                        : chr  "" "x" "" "" ...
     $ CBF                          : logi  NA NA NA NA NA NA ...
     $ MLL.rearranged               : logi  NA NA NA NA NA NA ...
     $ IDH1                         : chr  "0+T2:BL24" "0" "" "0" ...
     $ IDH2                         : chr  "0,46" "0" "" "0,48" ...
     $ ASXL1                        : chr  "0" "0,45" "" "0" ...
     $ BCOR                         : chr  "0,99" "0" "" "0" ...
     $ CBL                          : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ CEBPAdm                      : num  0 0 0 0 0 0 0 NA NA NA ...
     $ CSF3R                        : chr  "0" "0" "" "0" ...
     $ DNMT3A                       : chr  "0" "0" "" "0" ...
     $ ETV6                         : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ FLT3.TKD                     : chr  "0,06" "0" "0" "0" ...
     $ FLT3.ITD                     : num  0 0 0 0 0 0 0 NA NA NA ...
     $ GATA2                        : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ JAK2                         : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ KIT                          : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ NPM1.1                       : chr  "0,17" "0" "0" "0,42" ...
     $ NRAS                         : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ KRAS                         : chr  "0" "0" "" "0" ...
     $ PTPN11                       : chr  "0,17" "0" "" "0" ...
     $ PHF6                         : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ RAD21                        : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ RUNX1.1                      : chr  "0" "0,76" "" "0" ...
     $ SETBP1                       : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ SMC1A                        : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ STAG2                        : num  0 0 NA 0 0 0 0 NA NA NA ...
     $ SRSF2                        : chr  "0" "0" "" "0,47" ...
     $ SF3B1                        : num  0 0 NA 0 NA 0 0 NA NA NA ...
     $ TET2.1                       : chr  "0" "0,43" "" "0" ...
     $ U2AF1                        : chr  "0,45" "0" "" "0" ...
     $ WT1                          : num  0 0 NA 0 NA 0 0 NA NA NA ...
     $ TP53.1                       : chr  "0" "0" "mut" "0" ...
     $ ZRSR2                        : num  0 0 NA 0 NA 0 0 NA NA NA ...
     $ health_status                : chr  "AML" "AML" "AML" "AML" ...
     $ case_or_control              : chr  "case" "case" "case" "case" ...
     $ nr_cells_raw                 : int  6141 2186 3604 3190 1333 2499 2800 2995 2489 4008 ...
     $ nr_cells_cf                  : int  6127 2169 3385 3183 1278 2457 2793 2964 2476 3986 ...
     $ nr_cells_cf_ctf              : int  6127 2149 3353 3182 1265 2448 2787 2832 2399 3963 ...
     $ total_counts_raw_cf_ctf_gf   : num  16080180 4764256 7218310 8180661 2819870 ...
     $ nr_celltypes_cf_ctf_gf       : int  8 7 8 8 7 8 7 8 8 8 ...
     $ threshold_nr_celltypes       : chr  "greater or equal 7" "greater or equal 7" "greater or equal 7" "greater or equal 7" ...
     $ passed_threshold_nr_celltypes: chr  "True" "True" "True" "True" ...
    NULL


The ligand-receptor pair database is provided by the algorithm, but the user can also use a custom database. In this case, the custom database should have the columns named 'Ligand', 'Receptor' and 'Pair.Name'. 


```R
colnames(counts) <- anno_cells$cell_ID
rownames(anno_cells) <- anno_cells$cell_ID
```

## Thresholds

When calculation the interactions, it is possible to set three threshold: 
- `threshold_celltype_size` is a threshold for the minimum number of cells that a cell type should contain (in one sample). If the number of cells in the cell type of interest in a particular sample is less or equal to the `threshold_celltype_size`, then we consider this cell type as missing in this sample. This threshold affects the relative cell type abundance parameter (rho). The default value for the `threshold_celltype_size` is 4. 
- `threshold_nr_active_cells` is a threshold for the minimum number of active cells in a cell type (in the sample of interest). A cell is considered as active (for a specific gene), if it is expressing this gene above the `threshold_expr`. If the number of active cells (for a specific gene) in a cell type is smaller or equal to the `threshold_nr_active_cells`, i.e. does not pass the threshold, then it is set to zero (in this sample). This threshold affects the relative active fraction (phi) parameter. The default value for the `threshold_expr` is zero.
- `threshold_expr` is a threshold for an expression value of a gene in a cell. If an expression value af a gene in a cell is smaller or equal to the `threshold_expr` value, it will be set to zero. This threshold affects the relative active fraction (phi) and the relative mean expression (p) parameters. The default value for the `threshold_expr` is zero. In our analysis, we will set it arbitrarily to 0.05.


```R
# set threshold of the cell type size
threshold_celltype_size <- 6
print("threshold_celltype_size >")
print(threshold_celltype_size)
```

    [1] "threshold_celltype_size >"
    [1] 6



```R
# set threshold of the minimum number of active cells
threshold_nr_active_cells <- 6
print("threshold_nr_active_cells >")
print(threshold_nr_active_cells)
```

    [1] "threshold_nr_active_cells >"
    [1] 6



```R
# set threshold of expression
threshold_expr <- 0.1
print("threshold_expr >")
print(threshold_expr)
```

    [1] "threshold_expr >"
    [1] 0.1


## Calculate interactions


```R
# Renaming the cell_ID.1 column in anno_cells to "cell_ID"
# colnames(anno_cells)[colnames(anno_cells) == "cell_ID.1"] <- "cell_ID"
```


```R
# colnames(anno_cells)[colnames(anno_cells) == "cell_ID"] <- "cell_IDXX"
```


```R
print("calculate communication")
interactions = calculate_communication(counts = counts
                                       ,anno_samples = anno_samples
                                       ,anno_cells = anno_cells
                                       ,threshold_celltype_size = threshold_celltype_size
                                       ,threshold_nr_active_cells = threshold_nr_active_cells
                                       ,threshold_expr = threshold_expr
                                       ,lrp_database = LR_database
                                       )

# print(str(interactions))

```

    [1] "calculate communication"


    Warning message in e_cellType_gene(counts = counts_sub, anno_cells = anno_cells_sub, :
    “WARNING: sample AML-0160 does not contain cell type NK -- interactions for this cell type in this sample will get zero values.”
    Warning message in e_cellType_gene(counts = counts_sub, anno_cells = anno_cells_sub, :
    “WARNING: sample AML-2123 does not contain cell type DC -- interactions for this cell type in this sample will get zero values.”
    Warning message in e_cellType_gene(counts = counts_sub, anno_cells = anno_cells_sub, :
    “WARNING: sample AML-4340 does not contain cell type Ery -- interactions for this cell type in this sample will get zero values.”


## Calculate general statistics

The `general_stat` function calculates for each interaction several parameters that will be used for the QC, visualization and the differential communication analysis. 

Following parameters for the QC step will be stored in the `anno_interactions` list:
- mean expression of a ligand in the active fraction of the sending cell type within the control cohort (`mean_e_s_l_control`) and within the case cohort (`mean_e_s_l_case`). 
- mean  expression of a receptor in the active fraction of the receiving cell type within the control cohort (`mean_e_r_r_control`) and within the case cohort (`mean_e_r_r_case`).

Following parameters for the visualization will be stored in the `anno_interactions` list:
- log2 fold change of `rho_s` between the cases and the controls (`log2FC_rho_s`). It shows for each interaction, how the cell type abundance of the sending cell type changed in the cases compared to the controls.
- log2 fold change of `rho_r` between the cases and the controls (`log2FC_rho_r_r`). It shows for each interaction, how the cell type abundance of the receiving cell type changed in the cases compared to the controls.
- log2 fold change of `rho` between the cases and the controls (`log2FC_rho`). It shows for each interaction, how the whole `rho` parameter changed in the cases compared to the controls.
- log2 fold change of `phi_l_s` between the cases and the controls (`log2FC_phi_l_s`). It shows for each interaction, how the active fraction of the ligand in the sending cells changed in the cases compared to the controls.
- log2 fold change of `phi_r_r` between the cases and the controls (`log2FC_phi_r_r`). It shows for each interaction, how the active fraction of the receptors in the receiving cells changed in the cases compared to the controls.
- log2 fold change of `phi` between the cases and the controls (`log2FC_phi`). It shows for each interaction, how the whole `phi` parameter changed in the cases compared to the controls.
- log2 fold change of `p_l_s` between the cases and the controls (`log2FC_p_l_s`). It shows for each interaction, how the mean expression within the active fraction of the ligand in the sending cells changed in the cases compared to the controls.
- log2 fold change of `p_r_r` between the cases and the controls (`log2FC_p_r_r`). It shows for each interaction, how the mean expression within the active fraction of the receptor in the receiving cells changed in the cases compared to the controls.
- log2 fold change of `p` between the cases and the controls (`log2FC_p`). It shows for each interaction, how the whole `p` parameter changed in the cases compared to the controls.

Following parameter for the differential communication analysis will be stored in the `anno_interactions` list:
- log2 fold change of `weights` between the cases and the controls (`log2FC_weights`). It shows for each interaction, how the whole interaction weight changed in the cases compared to the controls.






```R
print("calculate general statistics")

interactions <- general_stat(comm_result = interactions
                                   ,verbose = FALSE#TRUE
)
print(str(interactions$anno_interactions))
```

    [1] "calculate general statistics"
    'data.frame':	151744 obs. of  19 variables:
     $ interaction_ID     : chr  "Mono:A2M_Mono:LRP1" "Mono:ACTR2_Mono:ADRB2" "Mono:ACTR2_Mono:LDLR" "Mono:ADM_Mono:ACKR3" ...
     $ ligand_gene_name   : chr  "A2M" "ACTR2" "ACTR2" "ADM" ...
     $ receptor_gene_name : chr  "LRP1" "ADRB2" "LDLR" "ACKR3" ...
     $ sending_cell_type  : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ receiving_cell_type: chr  "Mono" "Mono" "Mono" "Mono" ...
     $ mean_e_s_l_control : num  0.622 0.955 0.955 0.817 0.817 ...
     $ mean_e_s_l_case    : num  0.392 0.919 0.919 0.793 0.793 ...
     $ mean_e_r_r_control : num  0.84 0.778 0.795 0.57 0.778 ...
     $ mean_e_r_r_case    : num  0.779 0.606 0.726 0.513 0.606 ...
     $ log2FC_rho_s       : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho_r       : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho         : num  0.145 0.145 0.145 0.145 0.145 ...
     $ log2FC_phi_s_l     : num  0 0.0602 0.0602 0.6348 0.6348 ...
     $ log2FC_phi_r_r     : num  -0.0465 0.1784 0.1106 3.9132 0.1784 ...
     $ log2FC_phi         : num  0 0.39 0.321 7.291 0.607 ...
     $ log2FC_p_s_l       : num  -0.5479 -0.0555 -0.0555 -0.0443 -0.0443 ...
     $ log2FC_p_r_r       : num  -0.109 -0.329 -0.13 -0.125 -0.329 ...
     $ log2FC_p           : num  -0.832 -0.398 -0.204 -0.078 -0.39 ...
     $ log2FC_weights     : num  0 0.735 0.79 10.854 2.123 ...
    NULL


# QC

For the quality check, we use three filters: the **interaction weight filter**, the **presence per cohort filter** and the **ligand/receptor expression filter**. An interaction is considered of good quality, if it passes all three filters.

The **interaction weight filter** checks the log10 cumulative weight of the interaction. To pass this filter, the interaction needs to be greater than the `threshold_log10_cum_weight` threshold.


```R
threshold_log10_cum_weight <-  0.01
print("threshold_log10_cum_weight >")
print(threshold_log10_cum_weight)
```

    [1] "threshold_log10_cum_weight >"
    [1] 0.01


The **presence per cohort filter** checks the fraction of samples in which an interaction was detected (i.e. has a non-zero value) in the control cohort and in the case cohort. To pass this filter, an interaction needs to have a greater value than the `threshold_frac_samples_per_condition` threshold either in the control cohort or in the case cohort or in both.


```R
threshold_frac_samples_per_condition <-  0.6
print("threshold_frac_samples_per_condition >")
print(threshold_frac_samples_per_condition)
```

    [1] "threshold_frac_samples_per_condition >"
    [1] 0.6


The **ligand/receptor expression filter** checks the mean expression level of the ligand and the receptor of an interaction in the case and the control samples (separately). This filter uses a `threshold_log10meanexpr_per_condition` threshold.
For each interaction four values are checked:
- log10 mean expression of the ligand in sending cells in control samples
- log10 mean expression of the receptor in receiving cells in control samples
- log10 mean expression of the ligand in sending cells in case samples
- log10 mean expression of the receptor in receiving cells in case samples.


An interaction passes this filter if both its ligand and receptor pass the threshold either in control samples or in case samples or in both.


```R
threshold_log10_meanexpr_per_condition <- 0.02
print("threshold_log10_meanexpr_per_condition >")
print(threshold_log10_meanexpr_per_condition)
```

    [1] "threshold_log10_meanexpr_per_condition >"
    [1] 0.02


A good quality interaction should pass all filters.

The `filter_interactions` function produces one plot for the **interaction weight filter**, two plots for the **presence per cohort filter** (one for the controls and one for the cases) and two plots for the **ligand/receptor expression filter** (one for the controls and one for the cases). It writes the selected threshold values in the `thresholds` list of the interaction object and stores the filtering results as boolean vectors (one per threshold) in the `anno_interactions` list. The function does not subset the data, so if you want to change the filtering parameters, you can re-define the thresholds and re-run the `filter_interactions` function.


```R
print("filter weak interactions")

options(repr.plot.height = 10
       ,repr.plot.width = 16)
interactions <- filter_interactions(comm_result = interactions
                             ,threshold_frac_samples_per_condition = threshold_frac_samples_per_condition
                             ,threshold_log10_cum_weight = threshold_log10_cum_weight
                             ,threshold_log10_meanexpr_per_condition = threshold_log10_meanexpr_per_condition
)
```

    [1] "filter weak interactions"



    
![png](output_37_1.png)
    


    [1] "128616 out of 151744 interactions do not pass the thresholds for log10 cumulative interactions weight > 0.01 and fraction of expressing samples > 0.6 . Also  11844  interactions didn't pass the discrepancy filter.  In total, 128616  bad quality interactions will be removed and 23128 good quality interactions will remain."



    
![png](output_37_3.png)
    



```R
print(str(interactions$thresholds))
print(str(interactions$anno_interactions))
```

    List of 6
     $ threshold_expr                        : num 0.1
     $ threshold_nr_active_cells             : num 6
     $ threshold_celltype_size               : num 6
     $ threshold_log10_cum_weight            : num 0.01
     $ threshold_frac_samples_per_condition  : num 0.6
     $ threshold_log10_meanexpr_per_condition: num 0.02
    NULL
    'data.frame':	151744 obs. of  28 variables:
     $ interaction_ID                            : chr  "Mono:A2M_Mono:LRP1" "Mono:ACTR2_Mono:ADRB2" "Mono:ACTR2_Mono:LDLR" "Mono:ADM_Mono:ACKR3" ...
     $ ligand_gene_name                          : chr  "A2M" "ACTR2" "ACTR2" "ADM" ...
     $ receptor_gene_name                        : chr  "LRP1" "ADRB2" "LDLR" "ACKR3" ...
     $ sending_cell_type                         : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ receiving_cell_type                       : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ mean_e_s_l_control                        : num  0.622 0.955 0.955 0.817 0.817 ...
     $ mean_e_s_l_case                           : num  0.392 0.919 0.919 0.793 0.793 ...
     $ mean_e_r_r_control                        : num  0.84 0.778 0.795 0.57 0.778 ...
     $ mean_e_r_r_case                           : num  0.779 0.606 0.726 0.513 0.606 ...
     $ log2FC_rho_s                              : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho_r                              : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho                                : num  0.145 0.145 0.145 0.145 0.145 ...
     $ log2FC_phi_s_l                            : num  0 0.0602 0.0602 0.6348 0.6348 ...
     $ log2FC_phi_r_r                            : num  -0.0465 0.1784 0.1106 3.9132 0.1784 ...
     $ log2FC_phi                                : num  0 0.39 0.321 7.291 0.607 ...
     $ log2FC_p_s_l                              : num  -0.5479 -0.0555 -0.0555 -0.0443 -0.0443 ...
     $ log2FC_p_r_r                              : num  -0.109 -0.329 -0.13 -0.125 -0.329 ...
     $ log2FC_p                                  : num  -0.832 -0.398 -0.204 -0.078 -0.39 ...
     $ log2FC_weights                            : num  0 0.735 0.79 10.854 2.123 ...
     $ log10_cum_weight                          : num  0 0.148 0.288 0.259 0.125 ...
     $ frac_samples_controls                     : num  0 1 1 0.5 1 ...
     $ frac_samples_cases                        : num  0 0.714 0.857 0.571 0.714 ...
     $ passed_log10_cum_weight_filter            : logi  FALSE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_frac_samples_filter                : logi  FALSE TRUE TRUE FALSE TRUE TRUE ...
     $ passed_log10_meanexpr_control_filter      : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_log10_meanexpr_case_filter         : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_log10_meanexpr_per_condition_filter: logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_QC_filter                          : logi  FALSE TRUE TRUE FALSE TRUE TRUE ...
    NULL


# Differential Communication

For calculating statistically significant differential interactions between the cases and the controls, we need to define an adjusted p-value threshold and the log2 fold change threshold. 


```R
# Set up log2 fold change threshold. The default value is 1
threshold_log2FC <- 1
print(paste("[absolute] threshold_log2FC >",threshold_log2FC))
```

    [1] "[absolute] threshold_log2FC > 1"



```R
# Set up FDR threshold. The default value is 0.1
threshold_fdr <- 0.1
print(paste("threshold_fdr <",threshold_fdr))
```

    [1] "threshold_fdr < 0.1"


The `test_diff` function stores the thresholds in the `thresholds` list of the interactions object.

The `test_diff` function calculates a p-value for each interaction using a Wilcoxon test and adjusts for multiple testing using the FDR correction method. After that, the function checks whether the log2 fold change and the adjusted p-value thresholds were passed. An interaction is considered significant if it passes both thresholds. The `test_diff` function stores the results as a boolean vector to the `anno_interactions` list of the interactions object.




```R
print("calculate differential communication")
interactions <- test_diff(comm_result = interactions
                          ,threshold_fdr = threshold_fdr
                          ,which_test = "t-test"
                          ,threshold_log2FC = threshold_log2FC
                          
                         )
print(str(interactions$thresholds))
print(str(interactions$anno_interactions))
```

    [1] "calculate differential communication"
    [1] "We have 2779 dignificantly differential interactions"
    List of 8
     $ threshold_expr                        : num 0.1
     $ threshold_nr_active_cells             : num 6
     $ threshold_celltype_size               : num 6
     $ threshold_log10_cum_weight            : num 0.01
     $ threshold_frac_samples_per_condition  : num 0.6
     $ threshold_log10_meanexpr_per_condition: num 0.02
     $ threshold_fdr                         : num 0.1
     $ threshold_log2FC                      : num 1
    NULL
    'data.frame':	151744 obs. of  33 variables:
     $ interaction_ID                            : chr  "Mono:A2M_Mono:LRP1" "Mono:ACTR2_Mono:ADRB2" "Mono:ACTR2_Mono:LDLR" "Mono:ADM_Mono:ACKR3" ...
     $ ligand_gene_name                          : chr  "A2M" "ACTR2" "ACTR2" "ADM" ...
     $ receptor_gene_name                        : chr  "LRP1" "ADRB2" "LDLR" "ACKR3" ...
     $ sending_cell_type                         : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ receiving_cell_type                       : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ mean_e_s_l_control                        : num  0.622 0.955 0.955 0.817 0.817 ...
     $ mean_e_s_l_case                           : num  0.392 0.919 0.919 0.793 0.793 ...
     $ mean_e_r_r_control                        : num  0.84 0.778 0.795 0.57 0.778 ...
     $ mean_e_r_r_case                           : num  0.779 0.606 0.726 0.513 0.606 ...
     $ log2FC_rho_s                              : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho_r                              : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho                                : num  0.145 0.145 0.145 0.145 0.145 ...
     $ log2FC_phi_s_l                            : num  0 0.0602 0.0602 0.6348 0.6348 ...
     $ log2FC_phi_r_r                            : num  -0.0465 0.1784 0.1106 3.9132 0.1784 ...
     $ log2FC_phi                                : num  0 0.39 0.321 7.291 0.607 ...
     $ log2FC_p_s_l                              : num  -0.5479 -0.0555 -0.0555 -0.0443 -0.0443 ...
     $ log2FC_p_r_r                              : num  -0.109 -0.329 -0.13 -0.125 -0.329 ...
     $ log2FC_p                                  : num  -0.832 -0.398 -0.204 -0.078 -0.39 ...
     $ log2FC_weights                            : num  0 0.735 0.79 10.854 2.123 ...
     $ log10_cum_weight                          : num  0 0.148 0.288 0.259 0.125 ...
     $ frac_samples_controls                     : num  0 1 1 0.5 1 ...
     $ frac_samples_cases                        : num  0 0.714 0.857 0.571 0.714 ...
     $ passed_log10_cum_weight_filter            : logi  FALSE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_frac_samples_filter                : logi  FALSE TRUE TRUE FALSE TRUE TRUE ...
     $ passed_log10_meanexpr_control_filter      : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_log10_meanexpr_case_filter         : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_log10_meanexpr_per_condition_filter: logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_QC_filter                          : logi  FALSE TRUE TRUE FALSE TRUE TRUE ...
     $ p.value                                   : num  NA 0.137 0.184 NA 0.283 ...
     $ p.adj                                     : num  NA 0.241 0.29 NA 0.383 ...
     $ passed_FDR_threshold                      : logi  NA FALSE FALSE NA FALSE FALSE ...
     $ passed_log2FC_threshold                   : logi  FALSE FALSE FALSE TRUE TRUE TRUE ...
     $ sign                                      : logi  FALSE FALSE FALSE NA FALSE FALSE ...
    NULL


# Interplay of individual components

<img src="../components_scheme.png">

We defined six components that influence the behavior of each interaction:
- rho_s
- phi_s_l
- p_s_l
- rho_r
- phi_r_r
- p_r_r

Each of these components can be changing independently in different directions. Based on the log2FC of each of them, we will define their direction:

**Direction of the log2FC per component**:
- *log2FC_rho_s_direction
- *log2FC_phi_s_l_direction
- *log2FC_p_s_l_direction
- *log2FC_rho_r_direction
- *log2FC_phi_r_r_direction
- *log2FC_p_r_r_direction -- can have values:
    - 0 -- if the absolute log2FC is less than the threshold_log2FC_component, i.e. unchanged
    - 1 -- if the log2FC is greater than the threshold_log2FC_component, i.e. upregulated
    - -1 -- if the log2FC is less than minus threshold_log2FC_component, i.e. downregulated

Depending on how they interplay, we will split them into groups showing different characteristics.

First, it is important for us to know whether the components of only one of the two interacting partners are affected (either the sender or the receiver), or of both of them. To know this, we will calculate how many components were affected for each interacting partners:

**List of affected components per interacting partner**
- *components_affected_s* -- (sender) can have values:
- *components_affected_r* -- (receiver) can have values:
    - none
    - p
    - phi
    - rho
    - phi_p
    - rho_p
    - rho_phi
    - rho_phi_p

**Number of components affected per interacting partner**:
- *nr_comp_affected_s* -- (sender) can have values: 
    - 0, 1, 2, or 3
- *nr_comp_affected_r* -- (receiver) can have values: 
    - 0, 1, 2, or 3
- *nr_comp_affected_b* -- (both) can have values: 
    - 0, 1, 2, 3, 4, 5, or 6
    
**Which counterpart is affected**:
- *sender_or_receiver_affected* can have values:
    - none -- if nr component sender is = 0 and nr component receiver is = 0
    - sender -- if nr component sender is > 0 and nr component receiver is = 0
    - receiver -- if nr component sender is = 0 and nr component receiver is > 0
    - both -- if nr component sender is > 0 and nr component receiver is > 0
    
**Direction of the affected components per interacting partner**
- *direction_s* -- (sender) can have values:
- *direction_r* -- (receiver) can have values:
- *direction_b* -- (both) can have values:
    - none -- if zero components affected
    - up -- if >0 components affected in the same direction (upregulated)
    - down -- if >0 components affected in the same direction (downregulated)
    - both -- if >1 components affected in the opposite direction
    
If several components are affected, it is important to see, if the direction of the change is the same, such that the overall change is concordant, or it is opposite, such that the overall change is discordant.

**Concordance of direction of affected components per interacting partner**
- *concordance_s* -- (sender) can have values:
- *concordance_r* -- (receiver) can have values:
    - undefined -- if zero or one component is affected, i.e. not enough components to talk about concordance
    - concordant -- if several components are affected in the same direction
    - discordant -- if several components are affected in opposite directions
- *concordance_b* -- (both) can have values:
    - undefined -- if zero or one component is affected, i.e. not enough components to talk about concordance
    - concordant -- if several components are affected in the same direction
    - discordant -- if:
         - both concordance_s and concordance_r have one component changed each, but their direction is opposite
         - both concordance_s and concordance_r have several components changed each are both concordant, but their direction is opposite
         - either concordance_s or concordance_r is discordant while the other one is concordant
         - both concordance_s and concordance_r are discordant

**Interaction category**
 - *no_change* -- if log2FC of the interaction weight is did not pass the threshold_log2FC and none of the components is affected
    
 - *simple_decrease* -- if log2FC of the interaction weight is less than minus threshold_log2FC and only one of the components is affected and is downregulated
     
 - *simple_increase* -- if log2FC of the interaction weight is greater than the threshold_log2FC and only one of the components is affected and is upregulated
     
 - *concordant_decrease* -- if log2FC of the interaction weight is less than minus threshold_log2FC, several components are affected and all of them are downregulated
    
 - *concordant_increase* -- if log2FC of the interaction weight is greater than the threshold_log2FC, several components are affected and all of them are upregulated
    
 - *insufficient_compensation* -- if log2FC of the interaction weight is passed the threshold_log2FC in either direction and several components are affected disconcordantly
    
 - *sufficient_compensation* -- if log2FC of the interaction weight is did not pass the threshold_log2FC and several components are affected disconcordantly



```R
# calculate interactions of the individual components
interactions <- interaction_classes(interactions
                   ,threshold = threshold_log2FC)
print(str(interactions$anno_interactions))
```

    'data.frame':	151744 obs. of  52 variables:
     $ interaction_ID                            : chr  "Mono:A2M_Mono:LRP1" "Mono:ACTR2_Mono:ADRB2" "Mono:ACTR2_Mono:LDLR" "Mono:ADM_Mono:ACKR3" ...
     $ ligand_gene_name                          : chr  "A2M" "ACTR2" "ACTR2" "ADM" ...
     $ receptor_gene_name                        : chr  "LRP1" "ADRB2" "LDLR" "ACKR3" ...
     $ sending_cell_type                         : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ receiving_cell_type                       : chr  "Mono" "Mono" "Mono" "Mono" ...
     $ mean_e_s_l_control                        : num  0.622 0.955 0.955 0.817 0.817 ...
     $ mean_e_s_l_case                           : num  0.392 0.919 0.919 0.793 0.793 ...
     $ mean_e_r_r_control                        : num  0.84 0.778 0.795 0.57 0.778 ...
     $ mean_e_r_r_case                           : num  0.779 0.606 0.726 0.513 0.606 ...
     $ log2FC_rho_s                              : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho_r                              : num  -0.455 -0.455 -0.455 -0.455 -0.455 ...
     $ log2FC_rho                                : num  0.145 0.145 0.145 0.145 0.145 ...
     $ log2FC_phi_s_l                            : num  0 0.0602 0.0602 0.6348 0.6348 ...
     $ log2FC_phi_r_r                            : num  -0.0465 0.1784 0.1106 3.9132 0.1784 ...
     $ log2FC_phi                                : num  0 0.39 0.321 7.291 0.607 ...
     $ log2FC_p_s_l                              : num  -0.5479 -0.0555 -0.0555 -0.0443 -0.0443 ...
     $ log2FC_p_r_r                              : num  -0.109 -0.329 -0.13 -0.125 -0.329 ...
     $ log2FC_p                                  : num  -0.832 -0.398 -0.204 -0.078 -0.39 ...
     $ log2FC_weights                            : num  0 0.735 0.79 10.854 2.123 ...
     $ log10_cum_weight                          : num  0 0.148 0.288 0.259 0.125 ...
     $ frac_samples_controls                     : num  0 1 1 0.5 1 ...
     $ frac_samples_cases                        : num  0 0.714 0.857 0.571 0.714 ...
     $ passed_log10_cum_weight_filter            : logi  FALSE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_frac_samples_filter                : logi  FALSE TRUE TRUE FALSE TRUE TRUE ...
     $ passed_log10_meanexpr_control_filter      : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_log10_meanexpr_case_filter         : logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_log10_meanexpr_per_condition_filter: logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
     $ passed_QC_filter                          : logi  FALSE TRUE TRUE FALSE TRUE TRUE ...
     $ p.value                                   : num  NA 0.137 0.184 NA 0.283 ...
     $ p.adj                                     : num  NA 0.241 0.29 NA 0.383 ...
     $ passed_FDR_threshold                      : logi  NA FALSE FALSE NA FALSE FALSE ...
     $ passed_log2FC_threshold                   : logi  FALSE FALSE FALSE TRUE TRUE TRUE ...
     $ sign                                      : logi  FALSE FALSE FALSE NA FALSE FALSE ...
     $ log2FC_rho_s_direction                    : num  0 0 0 0 0 0 0 0 0 0 ...
     $ log2FC_phi_s_l_direction                  : num  0 0 0 0 0 0 0 0 0 0 ...
     $ log2FC_p_s_l_direction                    : num  0 0 0 0 0 0 0 0 0 0 ...
     $ log2FC_rho_r_direction                    : num  0 0 0 0 0 0 0 0 0 0 ...
     $ log2FC_phi_r_r_direction                  : num  0 0 0 1 0 0 0 1 0 -1 ...
     $ log2FC_p_r_r_direction                    : num  0 0 0 0 0 0 0 0 0 0 ...
     $ nr_comp_affected_s                        : num  0 0 0 0 0 0 0 0 0 0 ...
     $ nr_comp_affected_r                        : num  0 0 0 1 0 0 0 1 0 1 ...
     $ nr_comp_affected_b                        : num  0 0 0 1 0 0 0 1 0 1 ...
     $ components_affected_s                     : chr  "none" "none" "none" "none" ...
     $ components_affected_r                     : chr  "none" "none" "none" "phi" ...
     $ sender_or_receiver_affected               : Ord.factor w/ 4 levels "none"<"sender"<..: 1 1 1 3 1 1 1 3 1 3 ...
     $ direction_s                               : Ord.factor w/ 4 levels "none"<"up"<"down"<..: 1 1 1 1 1 1 1 1 1 1 ...
     $ direction_r                               : Ord.factor w/ 4 levels "none"<"up"<"down"<..: 1 1 1 2 1 1 1 2 1 3 ...
     $ direction_b                               : Ord.factor w/ 4 levels "none"<"up"<"down"<..: 1 1 1 2 1 1 1 2 1 3 ...
     $ concordance_s                             : Ord.factor w/ 3 levels "undefined"<"concordant"<..: 1 1 1 1 1 1 1 1 1 1 ...
     $ concordance_r                             : Ord.factor w/ 3 levels "undefined"<"concordant"<..: 1 1 1 1 1 1 1 1 1 1 ...
     $ concordance_b                             : Ord.factor w/ 3 levels "undefined"<"concordant"<..: 1 1 1 1 1 1 1 1 1 1 ...
     $ interaction_category                      : chr  "no_change" "no_change" "no_change" "simple_increase" ...
    NULL



```R

```


```R
# load("interactions.RData")
```


```R
write.csv(interactions$weights,paste0(output_dir,"community_weights.csv"))
```


```R
write.csv(interactions$anno_interactions,paste0(output_dir,"community_anno_interactions.csv"))
```


```R
print("save interactions.RData")
save(interactions, file = paste0(output_dir,"interactions.RData"))
```

    [1] "save interactions.RData"



```R

```
